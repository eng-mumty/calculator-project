<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculator - Shaqaynaysa</title>
  <style>
    :root{
      --bg:#0f1720;
      --panel:#111827;
      --btn:#1f2937;
      --accent:#10b981;
      --text:#e6eef6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,var(--bg),#071020);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    .calculator{
      width:360px;
      background:var(--panel);
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.7);
    }
    .display{
      width:100%;
      height:72px;
      background:#0b1220;
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      margin-bottom:12px;
    }
    .expression{
      font-size:18px;
      color:#9fb3c8;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding-right:6px;
    }
    .result{
      font-size:28px;
      text-align:right;
      font-weight:600;
      padding-right:6px;
    }
    .buttons{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:10px;
    }
    button{
      height:58px;
      border-radius:10px;
      border:0;
      background:var(--btn);
      color:var(--text);
      font-size:18px;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s;
      box-shadow: 0 3px 0 rgba(0,0,0,0.3);
    }
    button:active{ transform:translateY(2px); box-shadow:none; }
    .op{ background:#0ea5a3; }
    .eq{ grid-column:4/5; background:var(--accent); color:#041014; font-weight:700; }
    .wide{ grid-column:1/3; }
    .danger{ background:#ef4444; }
    .hint{ margin-top:10px; font-size:13px; color:#9aaec0; text-align:center; }
    @media (max-width:420px){
      .calculator{ width:92vw; }
    }
  </style>
</head>
<body>
  <div class="calculator" role="application" aria-label="Calculator">
    <div class="display" aria-live="polite">
      <div id="expression" class="expression"></div>
      <div id="result" class="result">0</div>
    </div>

    <div class="buttons" role="group" aria-label="Calculator buttons">
      <button id="btn-clear" class="danger">C</button>
      <button id="btn-del">DEL</button>
      <button id="btn-paren" class="op">( )</button>
      <button data-value="/" class="op">÷</button>

      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button data-value="*" class="op">×</button>

      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button data-value="-" class="op">−</button>

      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="+" class="op">+</button>

      <button data-value="0" class="wide">0</button>
      <button data-value="." id="dot">.</button>
      <button id="btn-eq" class="eq">=</button>
    </div>

    <div class="hint">Isticmaal mouse ama keyboard: digits, + - * / . Enter =, Backspace, Esc (clear)</div>
  </div>
   <script>
    // Elements
    const expEl = document.getElementById('expression');
    const resEl = document.getElementById('result');
    const buttons = document.querySelectorAll('button[data-value]');
    const btnClear = document.getElementById('btn-clear');
    const btnDel = document.getElementById('btn-del');
    const btnEq = document.getElementById('btn-eq');
    const btnParen = document.getElementById('btn-paren');
    const dotBtn = document.getElementById('dot');

    // State
    let expression = '';     // full expression string shown
    let lastWasOperator = false;
    let unmatchedParen = 0;

    // caawiyayaal ------------------------------------------------
    function updateUI(){
      expEl.textContent = expression || '';
      // Live-evaluate safe partial result (if expression valid so far)
      const safe = sanitizeForEval(expression);
      if(safe && safe.length && isExpressionValidPartial(expression)){
        try {
          const evaluated = safeEval(safe);
          resEl.textContent = String(evaluated);
        } catch {
          resEl.textContent = '...';
        }
      } else {
        resEl.textContent = expression ? '...' : '0';
      }
    }

    // Allow only digits, operators, parentheses and dots for eval.
    function sanitizeForEval(str){
      if(!str) return '';
      // replace visual × ÷ − with JS operators
      str = str.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
      // collapse repeated spaces
      str = str.replace(/\s+/g,'');
      // final check
      if(/^[0-9+\-*/(). ]+$/.test(str)) return str;
      return '';
    }

    // Quick check if expression is a reasonable partial (no two operators in row except unary minus after '(')
    function isExpressionValidPartial(expr){
      // disallow sequences like ++, **, //, .., +- (except when minus after '(' is allowed)
      if(/[\+\*\/]{2,}/.test(expr)) return false;
      if(/(\.\.)/.test(expr)) return false;
      if(/^[\+\*\/]/.test(expr)) return false; // cannot start with + * /
      return true;
    }

    // Safe eval: only use Function after sanitize check (still careful)
    function safeEval(sanitized){
      // Extra: prevent expressions ending with operator
      if(/[+\-*/.]$/.test(sanitized)) throw new Error('Ends with operator');
      // Use Function to evaluate (more controlled than eval); sanitized already checked
      // eslint-disable-next-line no-new-func
      return Function('"use strict"; return (' + sanitized + ')')();
    }

    // Input functions ---------------------------------------
    function pushValue(val){
      // map visual operators to JS internal for state tracking
      if(val === '÷') val = '/';
      if(val === '×') val = '*';
      if(val === '−') val = '-';

      // handle parentheses toggle (btn-paren)
      if(val === '( )'){
        // not used here
      }

      // Number or dot
      if(/[0-9]/.test(val)){
        expression += val;
        lastWasOperator = false;
        updateUI();
        return;
      }

      if(val === '.'){
        // prevent multiple dots in the current number part
        // find last operator position
        const lastOpIndex = Math.max(
          expression.lastIndexOf('+'),
          expression.lastIndexOf('-'),
          expression.lastIndexOf('*'),
          expression.lastIndexOf('/')
        );
        const currentNumber = expression.slice(lastOpIndex + 1);
        if(currentNumber.includes('.')) return; // ignore second dot
        if(currentNumber === '') {
          // if starting a number with dot, prepend 0
          expression += '0.';
        } else {
          expression += '.';
        }
        lastWasOperator = false;
        updateUI();
        return;
      }

      // parentheses button: toggles opening or closing depending on unmatched count

      if(val === '( )'){
        if(unmatchedParen === 0 || /[+\-*/(]$/.test(expression)){
          expression += '(';
          unmatchedParen++;
          lastWasOperator = true; // '(' behaves like operator boundary
        } else {
          // close if there is an unmatched one and last char is not operator
          if(unmatchedParen > 0 && !/[+\-*/(]$/.test(expression)){
            expression += ')';
            unmatchedParen--;
            lastWasOperator = false;
          } else {
            // if last is operator, we prefer open parenthesis instead
            expression += '(';
            unmatchedParen++;
            lastWasOperator = true;
          }
        }
        updateUI();
        return;
      }

      // operators + - * /
      if(/[+\-*/]/.test(val)){
        // allow unary minus if expression is empty or last is '('
        if(val === '-' && (expression === '' || /[(+\-*/]$/.test(expression))){
          expression += '-';
          lastWasOperator = false; // unary minus belongs to number
          updateUI();
          return;
        }
        // avoid two operators in row: replace previous operator with new one
        if(/[+\-*/]$/.test(expression)){
          // replace last operator with the new one
          expression = expression.slice(0, -1) + val;
        } else {
          expression += val;
        }
        lastWasOperator = true;
        updateUI();
        return;
      }
    }

    function clearAll(){
      expression = '';
      unmatchedParen = 0;
      lastWasOperator = false;
      updateUI();
    }

    function deleteLast(){
      if(!expression) return;
      const last = expression.slice(-1);
      expression = expression.slice(0, -1);
      if(last === '(') unmatchedParen = Math.max(0, unmatchedParen - 1);
      if(last === ')') unmatchedParen++;
      updateUI();
    }

    function calculate(){
      // If there are unmatched parentheses, try to auto-close them
      while(unmatchedParen > 0){
        expression += ')';
        unmatchedParen--;
      }
      const safe = sanitizeForEval(expression);
      if(!safe){
        resEl.textContent = 'Error';
        return;
      }
      try {
        const value = safeEval(safe);
        expression = String(value);
        // reset state
        lastWasOperator = false;
        unmatchedParen = 0;
        updateUI();
      } catch (e) {
        resEl.textContent = 'Error';
      }
    }

    // Attach button events
    buttons.forEach(btn => {
      btn.addEventListener('click', () => pushValue(btn.getAttribute('data-value')));
    });

    btnClear.addEventListener('click', clearAll);
    btnDel.addEventListener('click', deleteLast);
    btnEq.addEventListener('click', calculate);
    btnParen.addEventListener('click', () => pushValue('( )'));
    dotBtn.addEventListener('click', () => pushValue('.'));

    // Keyboard support
    window.addEventListener('keydown', (e) => {
      // allow numbers and operators
      if(/^[0-9]$/.test(e.key)){
        pushValue(e.key);
        e.preventDefault();
        return;
      }
      if(['+','-','*','/','.'].includes(e.key)){
        pushValue(e.key);
        e.preventDefault();
        return;
      }
      if(e.key === 'Enter' || e.key === '='){
        calculate();
        e.preventDefault();
        return;
      }
      if(e.key === 'Backspace'){
        deleteLast();
        e.preventDefault();
        return;
      }
      if(e.key === 'Escape'){
        clearAll();
        e.preventDefault();
        return;
      }
      if(e.key === '(' || e.key === ')'){
        // allow manual parentheses
        pushValue(e.key);
        e.preventDefault();
      }
    });

    // initialize
    updateUI();
  </script>
</body>

</html>
